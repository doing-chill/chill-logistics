name: CI/CD

on:
  push:
    branches: [prod]

jobs:
  build_and_push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # =========================
      # Docker Hub 로그인
      # =========================
      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{secrets.DOCKERHUB_USERNAME}}
          password: ${{secrets.DOCKERHUB_TOKEN}}

      # buildx 세팅 (멀티아키 필수)
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # =========================
      # Multi-arch build & push (latest only)
      # =========================
      - name: Build & Push Multi-Arch Images (latest)
        run: |
          set -euo pipefail
          
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/config-server:latest \
            -f config-server/Dockerfile \
            --push .

          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/schema-server:latest \
            -f schema-server/Dockerfile \
            --push .

  deploy_pi1:
    needs: build_and_push
    runs-on: ubuntu-latest

    steps:
      - name: Deploy raspberry Pi Server 1 (DB + schema/config)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{secrets.PI1_HOST}}
          username: ${{secrets.PI1_USER}}
          password: ${{secrets.PI1_PASSWORD}}
          port: ${{secrets.PI1_PORT}}
          script_stop: true
          script: |
            set -euo pipefail
            sudo rm -rf chill-logistics
            git clone -b prod --single-branch https://github.com/doing-chill/chill-logistics.git
            cd chill-logistics

            # =========================
            # 1) .env 생성
            # =========================
            cat > .env <<EOF
            DOCKERHUB_USERNAME=${{secrets.DOCKERHUB_USERNAME}}

            MYSQL1_ROOT_PASSWORD=${{secrets.MYSQL1_ROOT_PASSWORD}}
            MYSQL1_DATABASE=${{secrets.MYSQL1_DATABASE}}
            MYSQL1_USER=${{secrets.MYSQL1_USER}}
            MYSQL1_PASSWORD=${{secrets.MYSQL1_PASSWORD}}
            MYSQL1_PORT=${{secrets.MYSQL1_PORT}}

            MYSQL2_ROOT_PASSWORD=${{secrets.MYSQL2_ROOT_PASSWORD}}
            MYSQL2_DATABASE=${{secrets.MYSQL2_DATABASE}}
            MYSQL2_USER=${{secrets.MYSQL2_USER}}
            MYSQL2_PASSWORD=${{secrets.MYSQL2_PASSWORD}}
            MYSQL2_PORT=${{secrets.MYSQL2_PORT}}

            MYSQL3_ROOT_PASSWORD=${{secrets.MYSQL3_ROOT_PASSWORD}}
            MYSQL3_DATABASE=${{secrets.MYSQL3_DATABASE}}
            MYSQL3_USER=${{secrets.MYSQL3_USER}}
            MYSQL3_PASSWORD=${{secrets.MYSQL3_PASSWORD}}
            MYSQL3_PORT=${{secrets.MYSQL3_PORT}}

            CONFIG_PORT=${{secrets.CONFIG_PORT}}
            CONFIG_GIT_URI=${{secrets.CONFIG_GIT_URI}}
            CONFIG_GIT_USERNAME=${{secrets.CONFIG_GIT_USERNAME}}
            CONFIG_GIT_PASSWORD=${{secrets.CONFIG_GIT_PASSWORD}}
            CONFIG_GIT_BRANCH=${{secrets.CONFIG_GIT_BRANCH}}
            EOF

            echo "[OK] .env created"

            # =========================
            # 공통 함수: 컨테이너 healthy 대기
            # =========================
            wait_healthy () {
              local cname="$1"
              echo ">> waiting healthy: ${cname}"
              for i in $(seq 1 120); do
                status="$(docker inspect -f '{{.State.Health.Status}}' "${cname}" 2>/dev/null || true)"
                if [ "${status}" = "healthy" ]; then
                  echo ">> ${cname} is healthy"
                  return 0
                fi
                sleep 2
              done
              echo "!! ${cname} not healthy"
              docker logs "${cname}" --tail 200 || true
              return 1
            }

            # =========================
            # 2) DB up + 대기
            # =========================
            docker compose -f docker-compose.db.yml --env-file .env up -d
            wait_healthy chill-mysql1
            wait_healthy chill-mysql2
            wait_healthy chill-mysql3

            # =========================
            # 3) Docker Hub 로그인
            # =========================
            echo "${{secrets.DOCKERHUB_TOKEN}}" | docker login \
              -u "${{secrets.DOCKERHUB_USERNAME}}" --password-stdin

            # =========================
            # 4) schema / config pull & up
            # =========================
            docker compose -f docker-compose-01.yml --env-file .env up -d --pull always

            # =========================
            # 5) config-server 내부 헬스체크
            # =========================
            CID="$(docker compose -f docker-compose-01.yml ps -q config-server)"

            docker exec "$CID" curl -fsS "http://127.0.0.1:${CONFIG_PORT}/actuator/health"
  

            echo "Deploy & health checks done"
